<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PRIME X KILLER | Master System v2.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        
        body { 
            background: linear-gradient(rgba(5, 5, 5, 0.9), rgba(5, 5, 5, 0.9)), 
                        url('1000200137.jpg') center/cover no-repeat fixed; 
            color: white; 
            font-family: 'Plus Jakarta Sans', sans-serif;
            min-height: 100vh;
        }
        
        .m-glass { 
            background: rgba(15, 15, 20, 0.85); 
            backdrop-filter: blur(15px); 
            border: 1px solid rgba(139, 92, 246, 0.2); 
            border-radius: 28px; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .page { display: none; min-height: 100vh; padding-bottom: 120px; }
        .page.active { display: block; animation: fadeIn 0.4s ease; }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        .input-mobile { 
            background: rgba(15, 15, 15, 0.7); 
            border: 1px solid rgba(139, 92, 246, 0.3); 
            color: white; 
            padding: 16px; 
            border-radius: 18px; 
            width: 100%; 
            outline: none; 
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .input-mobile:focus {
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }
        
        .tab-bar { 
            position: fixed; 
            bottom: 15px; 
            left: 15px; 
            right: 15px; 
            height: 75px; 
            background: rgba(10, 10, 15, 0.95); 
            backdrop-filter: blur(20px); 
            border-radius: 25px; 
            display: flex; 
            justify-content: space-around; 
            align-items: center; 
            border: 1px solid rgba(139, 92, 246, 0.2);
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.4);
            z-index: 999; 
        }
        
        .tab-item { 
            color: #666; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            font-size: 10px; 
            font-weight: bold; 
            transition: all 0.3s ease;
            cursor: pointer;
            padding: 10px;
            border-radius: 12px;
        }
        
        .tab-item:hover { 
            color: #8b5cf6; 
            background: rgba(139, 92, 246, 0.1);
        }
        
        .tab-item.active { 
            color: #8b5cf6; 
            background: rgba(139, 92, 246, 0.15);
            transform: translateY(-5px);
        }
        
        .tab-item i { font-size: 18px; margin-bottom: 4px; }
        
        .btn-main { 
            background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); 
            padding: 16px; 
            border-radius: 18px; 
            font-weight: 800; 
            width: 100%; 
            border: none;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-main:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(139, 92, 246, 0.3);
        }
        
        .badge { 
            padding: 4px 10px; 
            border-radius: 8px; 
            font-size: 10px; 
            font-weight: 900; 
            text-transform: uppercase;
            display: inline-block;
            margin-left: 8px;
        }
        
        .owner { background: linear-gradient(135deg, #ff0055 0%, #cc0044 100%); color: white; }
        .admin { background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); color: white; }
        .reseller { background: linear-gradient(135deg, #10b981 0%, #0d9668 100%); color: white; }
        
        .modal { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.95); 
            backdrop-filter: blur(10px); 
            z-index: 9999; 
            align-items: center; 
            justify-content: center; 
            padding: 20px; 
            animation: fadeIn 0.3s ease;
        }
        
        .status-active { 
            background: rgba(16, 185, 129, 0.1); 
            border-left: 4px solid #10b981; 
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.1);
        }
        
        .status-expired { 
            background: rgba(239, 68, 68, 0.1); 
            border-left: 4px solid #ef4444;
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.1);
        }
        
        .key-item { 
            transition: all 0.3s ease; 
            cursor: pointer;
        }
        
        .key-item:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 10px 25px rgba(139, 92, 246, 0.25);
            border-color: rgba(139, 92, 246, 0.4);
        }
        
        .btn-danger { 
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); 
            padding: 12px; 
            border-radius: 18px; 
            font-weight: 800; 
            width: 100%; 
            border: none;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(239, 68, 68, 0.3);
        }
        
        .logo-container {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo-text {
            font-size: 2.8rem;
            font-weight: 900;
            background: linear-gradient(135deg, #8b5cf6 0%, #ff0055 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-style: italic;
            margin-bottom: 5px;
        }
        
        .logo-subtext {
            font-size: 0.9rem;
            color: #8b5cf6;
            font-weight: 600;
            letter-spacing: 8px;
            text-transform: uppercase;
        }
        
        .stats-box {
            transition: all 0.3s ease;
        }
        
        .stats-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
        }
        
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(15, 15, 20, 0.5);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
            border-radius: 10px;
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(139, 92, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0); }
        }
        
        .floating-button {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }
        
        .shine-effect {
            position: relative;
            overflow: hidden;
        }
        
        .shine-effect::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                to right,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.1) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            transform: rotate(30deg);
            transition: all 0.6s;
        }
        
        .shine-effect:hover::after {
            left: 100%;
        }
    </style>
</head>
<body>

    <!-- Edit User Modal -->
    <div id="editModal" class="modal">
        <div class="m-glass p-8 w-full max-w-md border-2 border-purple-500/50 shine-effect">
            <h3 class="text-xl font-extrabold mb-6 text-purple-400"><i class="fas fa-user-edit mr-2"></i>EDIT USER</h3>
            <input type="hidden" id="editTargetEmail">
            <div class="space-y-4">
                <input type="text" id="editName" placeholder="New Name" class="input-mobile">
                <input type="number" id="editCredits" placeholder="New Credits" class="input-mobile">
                <select id="editRole" class="input-mobile">
                    <option value="reseller">RESELLER</option>
                    <option value="admin">ADMIN</option>
                    <option value="owner">OWNER</option>
                </select>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="saveUserEdit()" class="btn-main pulse-animation"><i class="fas fa-save mr-2"></i>SAVE</button>
                    <button onclick="deleteUser()" class="btn-danger"><i class="fas fa-trash mr-2"></i>DELETE</button>
                </div>
                <div class="flex justify-center">
                    <button onclick="closeModal()" class="bg-white/10 px-10 py-3 rounded-2xl mt-2 hover:bg-white/20 transition">
                        <i class="fas fa-times mr-2"></i>CLOSE
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Key Modal -->
    <div id="editKeyModal" class="modal">
        <div class="m-glass p-8 w-full max-w-md border-2 border-yellow-500/50 shine-effect">
            <h3 class="text-xl font-extrabold mb-6 text-yellow-400"><i class="fas fa-key mr-2"></i>EDIT KEY</h3>
            <input type="hidden" id="editKeyId">
            <div class="space-y-4">
                <input type="text" id="editKeyValue" placeholder="Key" class="input-mobile" readonly>
                <input type="text" id="editKeyBuyer" placeholder="Buyer Name" class="input-mobile">
                <select id="editKeyStatus" class="input-mobile">
                    <option value="active">ACTIVE</option>
                    <option value="expired">EXPIRED</option>
                    <option value="revoked">REVOKED</option>
                </select>
                <select id="editKeyDuration" class="input-mobile">
                    <option value="1">1 DAY</option>
                    <option value="3">3 DAYS</option>
                    <option value="7">7 DAYS</option>
                    <option value="30">30 DAYS</option>
                    <option value="lifetime">LIFETIME</option>
                </select>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="saveKeyEdit()" class="btn-main pulse-animation"><i class="fas fa-sync-alt mr-2"></i>UPDATE</button>
                    <button onclick="deleteKey()" class="btn-danger"><i class="fas fa-trash mr-2"></i>DELETE</button>
                </div>
                <div class="flex justify-center">
                    <button onclick="closeKeyModal()" class="bg-white/10 px-10 py-3 rounded-2xl hover:bg-white/20 transition">
                        <i class="fas fa-times mr-2"></i>CLOSE
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Section -->
    <div id="authSection" class="min-h-screen flex flex-col items-center justify-center p-8">
        <div class="logo-container">
            <div class="logo-text">PRIME X</div>
            <div class="logo-subtext">KILLER</div>
        </div>
        
        <div id="loginBox" class="w-full max-w-md space-y-5">
            <div class="m-glass p-6">
                <input type="email" id="logEmail" placeholder="Email Address" class="input-mobile mb-4">
                <input type="password" id="logPass" placeholder="Password" class="input-mobile mb-6">
                <button onclick="handleLogin()" class="btn-main floating-button">
                    <i class="fas fa-sign-in-alt mr-2"></i>LOGIN
                </button>
                <p class="text-center text-xs text-gray-400 mt-4">
                    No account? 
                    <button onclick="toggleAuth('signup')" class="text-purple-400 font-bold hover:text-purple-300 transition">
                        Sign Up
                    </button>
                </p>
            </div>
        </div>

        <div id="signupBox" class="w-full max-w-md space-y-5 hidden">
            <div class="m-glass p-6">
                <input type="text" id="regUser" placeholder="Username" class="input-mobile mb-4">
                <input type="email" id="regEmail" placeholder="Email Address" class="input-mobile mb-4">
                <input type="password" id="regPass" placeholder="Create Password" class="input-mobile mb-4">
                <input type="text" id="regRef" placeholder="Referral Code (Optional)" class="input-mobile mb-6">
                <button onclick="handleSignup()" class="btn-main floating-button">
                    <i class="fas fa-user-plus mr-2"></i>REGISTER
                </button>
                <button onclick="toggleAuth('login')" class="w-full text-xs mt-4 text-gray-500 font-bold hover:text-white transition">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Login
                </button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="hidden">
        <header class="p-6 fixed top-0 w-full bg-black/80 backdrop-blur-xl z-50 flex justify-between items-center border-b border-purple-500/20">
            <div>
                <h2 id="displayUser" class="font-bold text-lg uppercase italic"></h2>
                <div id="roleBadgeContainer" class="mt-1"></div>
            </div>
            <div class="bg-purple-600/20 px-4 py-2 rounded-2xl border border-purple-500/30 hover:bg-purple-600/30 transition">
                <span id="userCredits" class="font-bold text-xl">0</span> 
                <i class="fas fa-coins text-yellow-500 ml-2"></i>
            </div>
        </header>

        <div class="pt-28 px-4 pb-32">
            <!-- Home Page -->
            <div id="homePage" class="page active">
                <div class="m-glass p-8 text-center border-l-4 border-purple-600 shine-effect">
                    <h3 class="text-xl font-bold mb-1"><i class="fas fa-signal mr-2"></i>Status: <span class="text-green-500">Online</span></h3>
                    <p class="text-gray-400 text-sm mt-2">Welcome to PRIME SIR.2</p>
                </div>
                
                <div class="mt-8 grid grid-cols-2 gap-5">
                    <div class="m-glass p-6 text-center stats-box">
                        <div class="text-4xl font-bold text-purple-400" id="totalKeys">0</div>
                        <div class="text-sm text-gray-400 mt-3">Total Keys</div>
                        <i class="fas fa-key text-purple-500/30 text-2xl mt-3"></i>
                    </div>
                    <div class="m-glass p-6 text-center stats-box">
                        <div class="text-4xl font-bold text-green-400" id="activeKeys">0</div>
                        <div class="text-sm text-gray-400 mt-3">Active Keys</div>
                        <i class="fas fa-check-circle text-green-500/30 text-2xl mt-3"></i>
                    </div>
                </div>
            </div>

            <!-- Create Page -->
            <div id="createPage" class="page">
                <div class="m-glass p-6 space-y-5 shine-effect">
                    <h3 class="font-bold text-lg text-purple-300"><i class="fas fa-magic mr-2"></i>Key Generator</h3>
                    <select id="gameSelect" class="input-mobile">
                        <option value="FREE FIRE">FREE FIRE</option>
                        <option value="BGMI">BGMI</option>
                        <option value="PUBG">PUBG</option>
                        <option value="CODM">CODM</option>
                    </select>
                    <select id="time" class="input-mobile">
                        <option value="1">1 DAY - 1 CREDIT</option>
                        <option value="3">3 DAYS - 2 CREDITS</option>
                        <option value="7">7 DAYS - 5 CREDITS</option>
                        <option value="30">30 DAYS - 15 CREDITS</option>
                        <option value="lifetime">LIFETIME - 50 CREDITS</option>
                    </select>
                    <input type="text" id="buyer" placeholder="Buyer Name (Optional)" class="input-mobile">
                    <button onclick="handleKeyGeneration()" class="btn-main floating-button">
                        <i class="fas fa-bolt mr-2"></i>GENERATE KEY
                    </button>
                    <div id="keyBox" class="hidden p-6 border-2 border-dashed border-purple-500/50 rounded-2xl text-center mt-6 bg-purple-500/10">
                        <code id="resKey" class="text-2xl font-bold select-all tracking-wider"></code>
                        <p class="text-xs text-gray-400 mt-3"><i class="fas fa-exclamation-triangle mr-1"></i>Save this key, it won't be shown again!</p>
                        <button onclick="copyKey()" class="mt-4 bg-purple-500/30 hover:bg-purple-500/40 text-purple-300 px-5 py-2.5 rounded-xl text-sm transition">
                            <i class="fas fa-copy mr-2"></i>Copy Key
                        </button>
                    </div>
                </div>
            </div>

            <!-- Key History Page -->
            <div id="keysPage" class="page">
                <div class="m-glass p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-lg text-purple-300"><i class="fas fa-history mr-2"></i>Key History</h3>
                        <div class="flex gap-3">
                            <select id="filterStatus" class="bg-black/50 text-xs p-2.5 rounded-xl border border-purple-500/20" onchange="filterKeys()">
                                <option value="all">ALL STATUS</option>
                                <option value="active">ACTIVE</option>
                                <option value="expired">EXPIRED</option>
                                <option value="revoked">REVOKED</option>
                            </select>
                            <select id="filterGame" class="bg-black/50 text-xs p-2.5 rounded-xl border border-purple-500/20" onchange="filterKeys()">
                                <option value="all">ALL GAMES</option>
                                <option value="FREE FIRE">FREE FIRE</option>
                                <option value="BGMI">BGMI</option>
                                <option value="PUBG">PUBG</option>
                                <option value="CODM">CODM</option>
                            </select>
                        </div>
                    </div>
                    <div id="keysList" class="space-y-4 max-h-[500px] overflow-y-auto pr-2"></div>
                </div>
            </div>

            <!-- Manage Users Page (Owner/Admin Only) -->
            <div id="managePage" class="page">
                <div class="m-glass p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-lg text-purple-300"><i class="fas fa-users-cog mr-2"></i>User Management</h3>
                        <button onclick="refreshUsers()" class="bg-purple-500/20 hover:bg-purple-500/30 text-purple-400 p-2.5 px-5 rounded-xl text-xs transition">
                            <i class="fas fa-sync-alt mr-2"></i> Refresh
                        </button>
                    </div>
                    <div id="usersList" class="space-y-4"></div>
                </div>
            </div>

            <!-- Profile Page -->
            <div id="profilePage" class="page">
                <div id="ownerOnlyBox" class="hidden m-glass p-6 border-2 border-yellow-500/30 mb-6">
                    <h3 class="text-xs text-yellow-500 font-bold mb-4 uppercase"><i class="fas fa-crown mr-2"></i>Owner Protocols</h3>
                    <div class="space-y-4">
                        <input type="text" id="customRef" placeholder="System Referral Code" class="input-mobile uppercase">
                        <select id="setRole" class="input-mobile">
                            <option value="reseller">RESELLER</option>
                            <option value="admin">ADMIN</option>
                        </select>
                        <input type="number" id="adminCreditAmount" class="input-mobile" placeholder="Initial Credits Amount">
                        <button onclick="updateSystem()" class="btn-main">
                            <i class="fas fa-save mr-2"></i>SAVE SETTINGS
                        </button>
                    </div>
                </div>
                
                <div class="m-glass p-6 mb-6">
                    <h3 class="font-bold text-lg text-purple-300 mb-4"><i class="fas fa-user-circle mr-2"></i>Account Info</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Username:</span>
                            <span id="profileUsername" class="font-bold"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Email:</span>
                            <span id="profileEmail" class="font-bold text-sm"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Role:</span>
                            <span id="profileRole" class="font-bold"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Credits:</span>
                            <span id="profileCredits" class="font-bold text-yellow-500"></span>
                        </div>
                    </div>
                </div>
                
                <button onclick="logout()" class="w-full bg-red-600/20 hover:bg-red-600/30 text-red-500 py-4 rounded-2xl border border-red-600/30 font-bold transition">
                    <i class="fas fa-sign-out-alt mr-2"></i>LOGOUT
                </button>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="tab-bar">
            <button onclick="switchTab('homePage', this)" class="tab-item active">
                <i class="fas fa-home"></i><span>Home</span>
            </button>
            <button onclick="switchTab('createPage', this)" class="tab-item">
                <i class="fas fa-plus-circle"></i><span>Create</span>
            </button>
            <button onclick="switchTab('keysPage', this)" class="tab-item">
                <i class="fas fa-key"></i><span>Keys</span>
            </button>
            <button onclick="switchTab('managePage', this)" id="manageBtn" class="tab-item hidden">
                <i class="fas fa-users-cog"></i><span>Users</span>
            </button>
            <button onclick="switchTab('profilePage', this)" class="tab-item">
                <i class="fas fa-user-shield"></i><span>Profile</span>
            </button>
        </nav>
    </div>

    <script>
        // API URLs
        const USER_API = "https://sheetdb.io/api/v1/dr3l2l1kzbwq4";
        const KEYS_API = "https://sheetdb.io/api/v1/dr3l2l1kzbwq4"; // New keys sheet
        const GOD_REF = "RAHUL_GOD_99";
        
        let user = null;
        let allKeys = [];

        // Auth Functions
        function toggleAuth(m) {
            const loginBox = document.getElementById('loginBox');
            const signupBox = document.getElementById('signupBox');
            
            if(m === 'signup') {
                loginBox.classList.add('hidden');
                signupBox.classList.remove('hidden');
            } else {
                signupBox.classList.add('hidden');
                loginBox.classList.remove('hidden');
            }
        }

        async function handleLogin() {
            const e = document.getElementById('logEmail').value.trim();
            const p = document.getElementById('logPass').value.trim();
            
            if(!e || !p) {
                alert("Please enter email and password!");
                return;
            }
            
            try {
                const res = await fetch(`${USER_API}/search?email=${encodeURIComponent(e)}&password=${encodeURIComponent(p)}`);
                const data = await res.json();
                
                if(data.length > 0) { 
                    user = data[0]; 
                    localStorage.setItem('modsUser', JSON.stringify(user)); 
                    startApp(); 
                } else {
                    alert("Invalid credentials!");
                }
            } catch (error) {
                console.error('Login error:', error);
                alert("Login failed! Check connection.");
            }
        }

        async function handleSignup() {
            const username = document.getElementById('regUser').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPass').value.trim();
            const r = document.getElementById('regRef').value.trim().toUpperCase();
            
            if(!username || !email || !password) {
                alert("Please fill all fields!");
                return;
            }
            
            const userData = { 
                username: username,
                email: email,
                password: password,
                referral: r,
                credits: (r === GOD_REF ? 999999 : 100),
                role: (r === GOD_REF ? 'owner' : 'reseller')
            };
            
            try {
                const response = await fetch(USER_API, { 
                    method:'POST', 
                    headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify({data:[userData]}) 
                });
                
                if(response.ok) {
                    alert("Registered Successfully!"); 
                    toggleAuth('login');
                } else {
                    alert("Registration failed! Email may already exist.");
                }
            } catch (error) {
                console.error('Signup error:', error);
                alert("Registration failed!");
            }
        }

        // App Functions
        function startApp() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            document.getElementById('displayUser').innerText = user.username || 'User';
            document.getElementById('userCredits').innerText = user.credits || 0;
            
            // Update profile info
            document.getElementById('profileUsername').innerText = user.username || 'N/A';
            document.getElementById('profileEmail').innerText = user.email || 'N/A';
            document.getElementById('profileRole').innerText = (user.role || 'reseller').toUpperCase();
            document.getElementById('profileCredits').innerText = user.credits || 0;
            
            const roleBadge = `<span class="badge ${user.role || 'reseller'}">${(user.role || 'reseller').toUpperCase()}</span>`;
            document.getElementById('roleBadgeContainer').innerHTML = roleBadge;

            // Show manage button for admin/owner
            if(user.role === 'owner' || user.role === 'admin') {
                document.getElementById('manageBtn').classList.remove('hidden');
                document.getElementById('ownerOnlyBox').classList.remove('hidden');
                fetchAllUsers();
            }

            // Load keys
            fetchKeys();
        }

        // Key Generation
        async function handleKeyGeneration() {
            const game = document.getElementById('gameSelect').value;
            const duration = document.getElementById('time').value;
            const buyer = document.getElementById('buyer').value.trim() || 'Anonymous';
            
            // Calculate credit cost
            const creditCost = {
                '1': 1,
                '3': 2,
                '7': 5,
                '30': 15,
                'lifetime': 50
            }[duration] || 1;

            // Check credits
            if(user.role !== 'owner' && (user.credits || 0) < creditCost) {
                alert(`Insufficient credits! Need ${creditCost} credits. You have ${user.credits || 0} credits.`);
                return;
            }

            // Generate key
            const keyId = 'NX-' + Math.random().toString(36).substr(2, 8).toUpperCase() + '-' + 
                         Math.random().toString(36).substr(2, 4).toUpperCase();
            
            // Calculate expiry date
            let expiryDate = new Date();
            let durationText = '';
            
            if(duration === 'lifetime') {
                expiryDate = 'LIFETIME';
                durationText = 'LIFETIME';
            } else {
                expiryDate.setDate(expiryDate.getDate() + parseInt(duration));
                expiryDate = expiryDate.toISOString().split('T')[0];
                durationText = duration + ' DAYS';
            }

            // Prepare key data for SheetDB
            const keyData = {
                "Key Code": keyId,
                "Game": game,
                "Duration": durationText,
                "Buyer": buyer,
                "Generated By": user.email || 'unknown',
                "Generated At": new Date().toISOString(),
                "Expiry Date": expiryDate,
                "Status": "active",
                "Credits Used": creditCost
            };

            console.log('Saving key:', keyData);

            try {
                // Save key to database
                const saveResponse = await fetch(KEYS_API, { 
                    method:'POST', 
                    headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify({data:[keyData]}) 
                });
                
                const saveResult = await saveResponse.json();
                console.log('Save response:', saveResult);

                // Deduct credits if not owner
                if(user.role !== 'owner') {
                    user.credits = (user.credits || 0) - creditCost;
                    document.getElementById('userCredits').innerText = user.credits;
                    document.getElementById('profileCredits').innerText = user.credits;
                    
                    await fetch(`${USER_API}/email/${encodeURIComponent(user.email)}`, { 
                        method:'PATCH', 
                        headers:{'Content-Type':'application/json'}, 
                        body:JSON.stringify({data:{credits: user.credits}}) 
                    });
                    
                    localStorage.setItem('modsUser', JSON.stringify(user));
                }

                // Show generated key
                document.getElementById('keyBox').classList.remove('hidden');
                document.getElementById('resKey').innerText = keyId;
                
                // Clear buyer field
                document.getElementById('buyer').value = '';
                
                // Refresh keys list after 1 second
                setTimeout(fetchKeys, 1000);
                
            } catch (error) {
                console.error('Error generating key:', error);
                alert("Error generating key! Check console for details.");
            }
        }

        function copyKey() {
            const keyText = document.getElementById('resKey').innerText;
            if(!keyText) return;
            
            if(navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(keyText).then(() => {
                    alert("✓ Key copied to clipboard!");
                }).catch(() => {
                    fallbackCopy(keyText);
                });
            } else {
                fallbackCopy(keyText);
            }
        }
        
        function fallbackCopy(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.opacity = "0";
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand("copy");
                alert("✓ Key copied to clipboard!");
            } catch (err) {
                console.error('Copy failed:', err);
                alert("Copy failed. Please copy manually.");
            }
            document.body.removeChild(textArea);
        }

        // Key Management
        async function fetchKeys() {
            try {
                console.log('Fetching keys from:', KEYS_API);
                const res = await fetch(KEYS_API);
                const data = await res.json();
                console.log('Fetched keys data:', data);
                
                // Ensure data is array
                allKeys = Array.isArray(data) ? data : [];
                console.log('Processed keys:', allKeys.length);
                
                displayKeys(allKeys);
                
                // Update stats
                const total = allKeys.length;
                const active = allKeys.filter(k => (k.Status || k.status) === 'active').length;
                
                document.getElementById('totalKeys').innerText = total;
                document.getElementById('activeKeys').innerText = active;
                
            } catch (error) {
                console.error('Error fetching keys:', error);
                allKeys = [];
                displayKeys([]);
                document.getElementById('totalKeys').innerText = '0';
                document.getElementById('activeKeys').innerText = '0';
            }
        }

        function displayKeys(keys) {
            const list = document.getElementById('keysList');
            list.innerHTML = '';
            
            if(!keys || keys.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-10 text-gray-500">
                        <i class="fas fa-key text-3xl mb-3 opacity-30"></i>
                        <p class="text-sm">No keys generated yet</p>
                    </div>`;
                return;
            }
            
            console.log('Displaying keys:', keys.length);
            
            // Sort by date (newest first)
            keys.sort((a,b) => {
                const dateA = new Date(a["Generated At"] || a.generated_at || 0);
                const dateB = new Date(b["Generated At"] || b.generated_at || 0);
                return dateB - dateA;
            });
            
            keys.forEach((key, index) => {
                const item = document.createElement('div');
                
                // Use correct field names from SheetDB
                const keyCode = key["Key Code"] || key.key || 'N/A';
                const game = key.Game || key.game || 'Unknown';
                const duration = key.Duration || key.duration || 'N/A';
                const buyer = key.Buyer || key.buyer || 'Anonymous';
                const generatedBy = key["Generated By"] || key.generated_by || 'Unknown';
                const generatedAt = key["Generated At"] || key.generated_at || new Date().toISOString();
                const expiry = key["Expiry Date"] || key.expiry || 'N/A';
                const status = key.Status || key.status || 'active';
                
                const statusClass = status === 'active' ? 'status-active' : 'status-expired';
                const statusColor = status === 'active' ? '#10b981' : 
                                  status === 'expired' ? '#ef4444' : '#f59e0b';
                
                item.className = `key-item bg-white/5 p-5 rounded-2xl border border-white/10 ${statusClass}`;
                
                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <code class="font-bold text-sm select-all tracking-wider">${keyCode}</code>
                                <span class="badge" style="background:${statusColor}; font-size:8px">${status.toUpperCase()}</span>
                                <span class="text-[10px] bg-purple-500/20 text-purple-300 px-2 py-1 rounded">${game}</span>
                            </div>
                            <p class="text-[11px] text-gray-400 mb-1"><i class="fas fa-user mr-1"></i>Buyer: ${buyer}</p>
                            <p class="text-[11px] text-gray-400 mb-1"><i class="fas fa-clock mr-1"></i>Duration: ${duration}</p>
                            <p class="text-[11px] text-gray-500 mb-1"><i class="fas fa-calendar-plus mr-1"></i>Generated: ${formatDate(generatedAt)}</p>
                            <p class="text-[11px] text-gray-500"><i class="fas fa-calendar-times mr-1"></i>Expires: ${expiry}</p>
                            <p class="text-[11px] text-yellow-500 mt-2"><i class="fas fa-user-tie mr-1"></i>By: ${generatedBy}</p>
                        </div>
                        ${(user.role === 'owner' || user.role === 'admin') ? `
                            <div class="flex flex-col gap-2 ml-3">
                                <button onclick="editKey('${keyCode}', '${buyer.replace(/'/g, "\\'")}', '${status}', '${duration}')" 
                                        class="bg-yellow-500/20 hover:bg-yellow-500/30 text-yellow-400 p-2 rounded-lg text-xs transition">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="toggleKeyStatus('${keyCode}', '${status === 'active' ? 'expired' : 'active'}')" 
                                        class="${status === 'active' ? 'bg-red-500/20 hover:bg-red-500/30 text-red-400' : 'bg-green-500/20 hover:bg-green-500/30 text-green-400'} p-2 rounded-lg text-xs transition">
                                    ${status === 'active' ? '<i class="fas fa-ban"></i>' : '<i class="fas fa-check"></i>'}
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function filterKeys() {
            const status = document.getElementById('filterStatus').value;
            const game = document.getElementById('filterGame').value;
            
            let filtered = allKeys;
            
            if(status !== 'all') {
                filtered = filtered.filter(k => (k.Status || k.status) === status);
            }
            
            if(game !== 'all') {
                filtered = filtered.filter(k => (k.Game || k.game) === game);
            }
            
            displayKeys(filtered);
        }

        // Key Editing
        function editKey(key, buyer, status, duration) {
            document.getElementById('editKeyModal').style.display = 'flex';
            document.getElementById('editKeyId').value = key;
            document.getElementById('editKeyValue').value = key;
            document.getElementById('editKeyBuyer').value = buyer;
            document.getElementById('editKeyStatus').value = status;
            
            // Extract numeric duration from text
            let durValue = '1';
            if(duration.includes('3')) durValue = '3';
            else if(duration.includes('7')) durValue = '7';
            else if(duration.includes('30')) durValue = '30';
            else if(duration.includes('LIFETIME') || duration.includes('lifetime')) durValue = 'lifetime';
            
            document.getElementById('editKeyDuration').value = durValue;
        }

        function closeKeyModal() {
            document.getElementById('editKeyModal').style.display = 'none';
        }

        async function saveKeyEdit() {
            const key = document.getElementById('editKeyId').value;
            const buyer = document.getElementById('editKeyBuyer').value.trim();
            const status = document.getElementById('editKeyStatus').value;
            const duration = document.getElementById('editKeyDuration').value;
            
            if(!key) {
                alert("Key not found!");
                return;
            }
            
            // Calculate new expiry if duration changed
            let expiryDate = new Date();
            let durationText = '';
            
            if(duration === 'lifetime') {
                expiryDate = 'LIFETIME';
                durationText = 'LIFETIME';
            } else {
                expiryDate.setDate(expiryDate.getDate() + parseInt(duration));
                expiryDate = expiryDate.toISOString().split('T')[0];
                durationText = duration + ' DAYS';
            }
            
            const data = { 
                "Buyer": buyer, 
                "Status": status,
                "Duration": durationText,
                "Expiry Date": expiryDate
            };
            
            try {
                const response = await fetch(`${KEYS_API}/Key Code/${encodeURIComponent(key)}`, { 
                    method:'PATCH', 
                    headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify({data: data}) 
                });
                
                if(response.ok) {
                    alert("✓ Key updated successfully!");
                    closeKeyModal();
                    fetchKeys();
                } else {
                    alert("Error updating key!");
                }
            } catch (error) {
                console.error('Error updating key:', error);
                alert("Error updating key!");
            }
        }

        async function deleteKey() {
            const key = document.getElementById('editKeyId').value;
            if(!confirm(`Are you sure you want to DELETE key: ${key}?\n\nThis action cannot be undone!`)) return;
            
            try {
                const response = await fetch(`${KEYS_API}/Key Code/${encodeURIComponent(key)}`, { 
                    method:'DELETE'
                });
                
                if(response.ok) {
                    alert("✓ Key deleted successfully!");
                    closeKeyModal();
                    fetchKeys();
                } else {
                    alert("Error deleting key!");
                }
            } catch (error) {
                console.error('Error deleting key:', error);
                alert("Error deleting key!");
            }
        }

        async function toggleKeyStatus(key, newStatus) {
            if(!confirm(`Are you sure you want to ${newStatus === 'active' ? 'activate' : 'expire'} this key?`)) return;
            
            try {
                await fetch(`${KEYS_API}/Key Code/${encodeURIComponent(key)}`, { 
                    method:'PATCH', 
                    headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify({data: {"Status": newStatus}}) 
                });
                
                fetchKeys();
            } catch (error) {
                console.error('Error updating key status:', error);
                alert("Error updating key status!");
            }
        }

        // User Management
        async function fetchAllUsers() {
            const list = document.getElementById('usersList');
            list.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Loading users...</div>';
            
            try {
                const res = await fetch(USER_API); 
                const all = await res.json();
                list.innerHTML = '';
                
                if(!all || all.length === 0) {
                    list.innerHTML = `
                        <div class="text-center py-10 text-gray-500">
                            <i class="fas fa-users text-3xl mb-3 opacity-30"></i>
                            <p class="text-sm">No users found</p>
                        </div>`;
                    return;
                }
                
                all.forEach(u => {
                    const d = document.createElement('div');
                    d.className = "bg-white/5 p-5 rounded-2xl flex justify-between items-center border border-white/10 hover:bg-white/10 transition-all";
                    d.innerHTML = `
                        <div class="flex-1">
                            <p class="font-bold text-sm flex items-center">${u.username || 'N/A'} 
                                <span class="badge ${u.role || 'reseller'}" style="font-size:7px; margin-left:8px">${(u.role || 'reseller').toUpperCase()}</span>
                            </p>
                            <p class="text-gray-400 text-[11px] mt-1"><i class="fas fa-envelope mr-1"></i>${u.email || 'No email'}</p>
                            <div class="flex gap-4 mt-2">
                                <p class="text-yellow-500 text-[11px]"><i class="fas fa-coins mr-1"></i>${u.credits || 0} CR</p>
                                <p class="text-blue-400 text-[11px]"><i class="fas fa-code mr-1"></i>Ref: ${u.referral || 'N/A'}</p>
                            </div>
                        </div>
                        <button onclick="openModal('${u.email}', '${(u.username || '').replace(/'/g, "\\'")}', '${u.credits || 0}', '${u.role || 'reseller'}')" 
                                class="bg-purple-500/20 hover:bg-purple-500/30 text-purple-400 p-2 px-4 rounded-xl text-xs transition ml-3">
                            <i class="fas fa-edit mr-1"></i>EDIT
                        </button>`;
                    list.appendChild(d);
                });
            } catch (error) {
                console.error('Error fetching users:', error);
                list.innerHTML = '<div class="text-center py-8 text-red-400"><i class="fas fa-exclamation-triangle mr-2"></i>Error loading users</div>';
            }
        }

        function refreshUsers() {
            fetchAllUsers();
        }

        function openModal(email, name, credits, role) {
            document.getElementById('editModal').style.display = 'flex';
            document.getElementById('editTargetEmail').value = email;
            document.getElementById('editName').value = name;
            document.getElementById('editCredits').value = credits;
            document.getElementById('editRole').value = role;
        }

        function closeModal() { 
            document.getElementById('editModal').style.display = 'none'; 
        }

        async function saveUserEdit() {
            const email = document.getElementById('editTargetEmail').value;
            const name = document.getElementById('editName').value.trim();
            const credits = parseInt(document.getElementById('editCredits').value) || 0;
            const role = document.getElementById('editRole').value;
            
            if(!name) {
                alert("Please enter a valid name!");
                return;
            }
            
            const data = { 
                username: name, 
                credits: credits, 
                role: role 
            };
            
            try {
                const response = await fetch(`${USER_API}/email/${encodeURIComponent(email)}`, { 
                    method:'PATCH', 
                    headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify({data: data}) 
                });
                
                if(response.ok) {
                    alert("✓ User updated successfully!"); 
                    closeModal(); 
                    fetchAllUsers();
                } else {
                    alert("Error updating user!");
                }
            } catch (error) {
                console.error('Error updating user:', error);
                alert("Error updating user!");
            }
        }

        async function deleteUser() {
            const email = document.getElementById('editTargetEmail').value;
            
            if(email === user.email) {
                alert("You cannot delete yourself!");
                return;
            }
            
            if(!confirm(`Are you sure you want to DELETE user: ${email}?\n\nThis action cannot be undone!`)) return;
            
            try {
                const response = await fetch(`${USER_API}/email/${encodeURIComponent(email)}`, { 
                    method:'DELETE'
                });
                
                if(response.ok) {
                    alert("✓ User deleted successfully!");
                    closeModal();
                    fetchAllUsers();
                } else {
                    alert("Error deleting user!");
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                alert("Error deleting user!");
            }
        }

        async function updateSystem() {
            const customRef = document.getElementById('customRef').value.trim().toUpperCase();
            const credits = parseInt(document.getElementById('adminCreditAmount').value) || 100;
            const role = document.getElementById('setRole').value;
            
            const data = { 
                referral: customRef || GOD_REF,
                credits: credits,
                role: role
            };
            
            try {
                const response = await fetch(`${USER_API}/email/${encodeURIComponent(user.email)}`, { 
                    method:'PATCH', 
                    headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify({data: data}) 
                });
                
                if(response.ok) {
                    alert("✓ System settings updated!"); 
                    location.reload();
                } else {
                    alert("Error updating system!");
                }
            } catch (error) {
                console.error('Error updating system:', error);
                alert("Error updating system!");
            }
        }

        // Utility Functions
        function switchTab(id, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            
            // Refresh data when switching to certain tabs
            if(id === 'keysPage') fetchKeys();
            if(id === 'managePage' && (user.role === 'owner' || user.role === 'admin')) fetchAllUsers();
        }

        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                if(isNaN(date.getTime())) return dateString;
                
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const year = date.getFullYear();
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                
                return `${day}/${month}/${year} ${hours}:${minutes}`;
            } catch {
                return dateString;
            }
        }

        function logout() { 
            if(confirm("Are you sure you want to logout?")) {
                localStorage.clear(); 
                location.reload(); 
            }
        }

        // Initialize
        window.onload = () => { 
            if(localStorage.getItem('modsUser')) { 
                try {
                    user = JSON.parse(localStorage.getItem('modsUser')); 
                    startApp(); 
                } catch {
                    localStorage.clear();
                }
            } 
            
            // Add keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Ctrl+L to focus login
                if(e.ctrlKey && e.key === 'l' && !user) {
                    e.preventDefault();
                    document.getElementById('logEmail').focus();
                }
                
                // Escape to close modals
                if(e.key === 'Escape') {
                    closeModal();
                    closeKeyModal();
                }
            });
        }
        
        // Add visual feedback for buttons
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('button').forEach(button => {
                button.addEventListener('mousedown', function() {
                    this.style.transform = 'scale(0.98)';
                });
                button.addEventListener('mouseup', function() {
                    this.style.transform = '';
                });
                button.addEventListener('mouseleave', function() {
                    this.style.transform = '';
                });
            });
        });
    </script>
</body>
</html>